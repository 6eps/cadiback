#!/bin/sh

debug=no

usage () {
cat <<EOF
usage: configure [-h][-g]
EOF
exit 0
}

die () {
  echo "configure: error: $*" 1>&2
  exit 1
}

msg () {
  echo "[configure] $*"
}

checkdir () {
  [ -d "$1" ] || die "could not find '$1'"
}

checkfile () {
  [ -f "$1" ] || die "could not find '$1'"
}

[ x"$CADICAL" = x ] && CADICAL="../cadical"

checkdir "$CADICAL"
cadicalversion="`cat $CADICAL/VERSION`"
msg "Using CADICAL='$CADICAL' version '$cadicalversion'"

checkdir "$CADICAL/src"
checkdir "$CADICAL/build"

checkfile "$CADICAL/src/cadical.hpp"
checkfile "$CADICAL/build/libcadical.a"

if [ x"`grep 'bool flip' $CADICAL/src/cadical.hpp`" = x ]
then
  msg "CaDiCaL does not support 'bool flip (int lit)'"
  flip=no
else
  msg "CaDiCaL supports 'bool flip (int lit)'"
  flip=yes
fi

while [ $# -gt 0 ]
do
  case $1 in
    -h) usage;;
    -g) debug=yes;;
    *) die "invalid option '%s' (try '-h')";;
  esac
  shift
done

if [ x"$CXX" = x ]
then
  COMPILE="g++ -Wall"
else
  COMPILE="$CXX -W"
fi

if [ $debug = yes ]
then
  COMPILE="$COMPILE -g -ggdb3"
else
  COMPILE="$COMPILE -O3 -DNDEBUG"
fi

[ $flip = no ] && COMPILE="$COMPILE -DNFLIP"

msg "Compiling with '$COMPILE'"

rm -f makefile
sed -e "s/@COMPILE@/$COMPILE/" makefile.in > makefile

msg "Generated 'makefile' (run 'make' to compile)"
